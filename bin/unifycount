#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__),'../lib/'))
require 'unifycount'
require 'rubygems'
require 'commander/import'
require 'pp'
require 'pry'
program :version, '0.0.1'
program :description, 'Merges the play count of the banshee music library into the iTunes music library'
 
command :backup do |c|
  c.syntax = 'unifycount backup [options]'
  c.summary = ''
  c.description = ''
  c.example 'description', 'command example'
  c.option '-o' , '--option OPT', 'Some switch that does something'
  c.option '-a' , '--action ACT', 'Some acion'
  c.action do |args, options|
    # Do something or c.when_called Unifycount::Commands::Backup
    pp args
    puts
    pp options
    puts options.option
  end
end

command :merge do |c|
  c.syntax = 'unifycount merge [options]'
  c.summary = 'Merges the play count of the banshee library into the iTunes Library'
  c.description = c.summary
  c.example 'To merge the libraries on a typical installation do:',
    'unifycount merge -b ~/.config/banshee-1/banshee.db -i /.../iTunes/iTunes Music Library.xml'
  c.option '-b', '--banshee-library FILE', String, 'Specify the banshee.db file.'
  c.option '-i', '--itunes-library FILE', String, 'Specify the iTunes Music Library.xml file'
  c.action do |args, options|
    unless options.banshee_library 
      puts "Error. Missing option -b."
      exit
    end
    unless options.itunes_library 
      puts "Error. Missing option -i."
      exit
    end

    begin
      itunes = UnifyCount::ItunesAdapter.new(options.itunes_library)
      # binding.pry

      banshee = UnifyCount::BansheeAdapter.new(options.banshee_library)
      itunes_tracks = UnifyCount::TrackList.new(itunes)
      banshee_tracks = UnifyCount::TrackList.new(banshee)
      itunes_tracks.update_with(banshee_tracks)

      itunes_tracks.save
      banshee_tracks.save
    rescue UnifyCount::BansheeAdapter::BansheeLibraryNotFound => e
      puts "Error. Couldn't open the banshee library"
    rescue UnifyCount::ItunesAdapter::ItunesLibraryNotFound => e
      puts "Error. Couldn't open the itunes library"
    end
      
  end
end

